# Follower 改进说明

## 改进内容

### 1. 方向控制（使用边缘传感器）
- **原理**：使用最左（Sensor 0）和最右（Sensor 4）的线传感器来判断Leader的方向
- **逻辑**：
  - 如果两个边缘传感器的读数都接近0（或低于阈值）→ **直行**
  - 如果左侧传感器（S0）有读数 → Leader在左侧 → **左转**
  - 如果右侧传感器（S4）有读数 → Leader在右侧 → **右转**

### 2. 距离控制（保持6-10cm）
- **原理**：使用中间三个传感器（S1, S2, S3）的平均IR强度来判断距离
- **距离策略**：
  - IR信号 > 200 → **太近** → 停止
  - IR信号 150-200 → **稍近** → 慢速（15 PWM）
  - IR信号 80-150 → **最佳距离（6-10cm）** → 正常速度（25 PWM）
  - IR信号 30-80 → **稍远** → 快速接近（40 PWM）
  - IR信号 < 30 → **太远** → 未检测到，停止

## 关键参数说明

### 方向控制参数
```cpp
const float TURN_SPEED = 35.0f;                    // 转向速度
const float SIDE_SENSOR_THRESHOLD = 50.0f;         // 边缘传感器检测阈值
```
- `TURN_SPEED`：转向时的速度差，越大转得越快
- `SIDE_SENSOR_THRESHOLD`：边缘传感器的灵敏度，越小越灵敏

### 距离控制参数（⚠️ 需要根据实际测试调整）
```cpp
const float IR_TOO_CLOSE = 200.0f;      // 太近（<6cm）
const float IR_OPTIMAL_MIN = 80.0f;     // 最佳距离下限（~10cm）
const float IR_OPTIMAL_MAX = 150.0f;    // 最佳距离上限（~6cm）
const float IR_TOO_FAR = 30.0f;         // 太远（>10cm）
```

### 速度参数
```cpp
const float SPEED_FAST = 40.0f;         // 快速接近
const float SPEED_NORMAL = 25.0f;       // 正常跟随
const float SPEED_SLOW = 15.0f;         // 减速
```

## 调试和校准步骤

### 第一步：观察传感器读数
1. 上传代码到Follower机器人
2. 打开串口监视器（9600波特率）
3. 启动Leader，观察串口输出的传感器读数：
   ```
   传感器 | L0: xxx | L4: xxx | Center: xxx
   ```

### 第二步：校准距离阈值
1. 手动调整Leader和Follower的距离：
   - 6cm距离 → 记录Center的IR信号值 → 设置为 `IR_OPTIMAL_MAX`
   - 10cm距离 → 记录Center的IR信号值 → 设置为 `IR_OPTIMAL_MIN`
   - 4cm距离 → 记录Center的IR信号值 → 设置为 `IR_TOO_CLOSE`
   - 15cm距离 → 记录Center的IR信号值 → 设置为 `IR_TOO_FAR`

2. **注意**：这些值会受到以下因素影响：
   - 桌面颜色（黑色/白色）
   - Leader的IR发射强度
   - 环境光线

### 第三步：调整方向灵敏度
1. 观察串口输出的"方向误差"值
2. 如果Follower转向太敏感 → 增大 `SIDE_SENSOR_THRESHOLD`
3. 如果Follower转向不够灵敏 → 减小 `SIDE_SENSOR_THRESHOLD`
4. 如果转向速度太快/太慢 → 调整 `TURN_SPEED`

### 第四步：优化速度
1. 测试不同距离下的跟随表现
2. 调整 `SPEED_FAST`、`SPEED_NORMAL`、`SPEED_SLOW`
3. 建议：
   - `SPEED_FAST` = 1.5-2倍 `SPEED_NORMAL`
   - `SPEED_SLOW` = 0.5-0.7倍 `SPEED_NORMAL`

## 串口调试输出说明

```
传感器 | L0: 450 | L4: 320 | Center: 850
控制 | IR信号: 120.5 | 方向误差: 130.0 | 速度: 25 | 转向: 0
状态 | 距离: 最佳距离 | 方向: 右转 | PWM L/R: 25/25
---
```

- **L0/L4**：左右边缘传感器的原始读数
- **Center**：中间传感器的平均读数
- **IR信号**：相对于背景的信号增强值（用于距离判断）
- **方向误差**：正值=Leader在右侧，负值=Leader在左侧
- **距离状态**：太近/最佳距离/稍远/太远
- **方向状态**：直行/左转/右转
- **PWM L/R**：左右轮的实际PWM值

## 常见问题

### Q1: Follower无法检测到Leader
**解决方案**：
1. 检查Leader是否正确发射IR（EMIT_PIN设置为OUTPUT+HIGH）
2. 检查Follower是否关闭了自己的IR发射（EMIT_PIN设置为INPUT）
3. 降低 `IR_TOO_FAR` 阈值
4. 确保两个机器人距离不要太远（建议<20cm测试）

### Q2: Follower总是停止，显示"太近"
**解决方案**：
1. 增大 `IR_TOO_CLOSE` 阈值
2. 检查是否有环境IR干扰
3. 重新校准背景值

### Q3: Follower方向控制不稳定，左右摇摆
**解决方案**：
1. 增大 `SIDE_SENSOR_THRESHOLD`（降低灵敏度）
2. 减小 `TURN_SPEED`（降低转向速度）
3. 转向时减速比例从0.7调整到0.5（第153行）

### Q4: 无法保持6-10cm距离
**解决方案**：
1. 重新校准距离阈值（按照上述步骤2）
2. 调整速度差异，使距离控制更平滑
3. 考虑添加PID控制器来控制距离（更高级的方案）

## 下一步改进建议

如果当前的简单控制不够精确，可以考虑：

1. **距离PID控制**：用PID控制器替代简单的速度分档，实现更平滑的距离控制
2. **方向PID控制**：用PID控制器替代固定的转向速度，实现更精确的方向对齐
3. **传感器融合**：结合Bump传感器的前向IR信号，提供更可靠的距离测量
4. **动态阈值**：根据环境光自动调整阈值
5. **预测控制**：使用编码器信息预测Leader的移动趋势

## 代码结构

```
followLeaderImproved()
├── 1. 读取传感器
│   ├── getDirectionFromEdgeSensors() - 方向（S0和S4）
│   └── getCenterIRStrength() - 距离（S1,S2,S3平均）
├── 2. 检测Leader
├── 3. 距离判断 → 前进速度
│   ├── 太近 → 停止
│   ├── 稍近 → 慢速
│   ├── 最佳 → 正常
│   └── 稍远 → 快速
├── 4. 方向判断 → 转向调整
│   ├── 两边都低 → 直行
│   ├── 左侧高 → 左转
│   └── 右侧高 → 右转
├── 5. 转向时减速
├── 6. 计算左右轮PWM
└── 7. 调试输出
```

## 测试建议

1. **静态测试**：
   - 固定Leader位置
   - 手动移动Follower到不同位置和角度
   - 观察Follower的反应

2. **动态测试**：
   - 让Leader以恒定速度直线前进
   - 观察Follower是否能保持距离和方向

3. **转向测试**：
   - 让Leader缓慢转弯
   - 观察Follower是否能跟随

4. **极限测试**：
   - 让Leader突然加速/减速
   - 让Leader急转弯
   - 测试系统的响应能力

祝你测试顺利！🤖

